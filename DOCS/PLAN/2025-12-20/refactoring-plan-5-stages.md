# План рефакторинга REST приложения Bitrix24

**Дата создания:** 2025-12-20 20:00 (UTC+3, Брест)  
**Версия:** 1.0  
**Статус:** План  
**Приоритет:** Высокий  
**Исполнитель:** Рефактор-менеджер + Bitrix24 Программист

---

## Цель рефакторинга

Улучшить архитектуру кодовой базы REST приложения Bitrix24, сохранив **весь текущий функционал**:
- Защита от прямого доступа
- Система управления правами доступа
- Получение данных текущего пользователя
- Анализ токенов и прав доступа
- Конфигурируемый доступ к главной странице

**Принцип:** Рефакторинг без изменения функциональности — только улучшение структуры кода.

---

## Текущие проблемы архитектуры

### 1. Монолитные файлы
- `index.php` — 1124 строки с множеством функций
- Смешение логики, HTML и PHP в одном файле

### 2. Дублирование кода
- Функция `getCurrentUserData()` дублируется в `index.php` и `token-analysis.php`
- Логика получения домена портала повторяется в нескольких файлах
- Проверка администратора реализована в разных местах

### 3. Отсутствие четкой структуры
- Функции разбросаны по файлам без четкой организации
- Нет разделения на слои (сервисы, контроллеры, представления)
- Сложно тестировать отдельные компоненты

### 4. Смешение ответственности
- Файлы содержат и бизнес-логику, и представление
- Нет единой точки входа для работы с Bitrix24 API
- Конфигурация разбросана по нескольким JSON-файлам

---

## План рефакторинга (5 этапов)

### Этап 1: Выделение сервисного слоя
**Цель:** Создать классы-сервисы для работы с Bitrix24 API, пользователями и конфигурацией

**Задачи:**
1. Создать структуру директорий для сервисов
2. Создать класс `Bitrix24ApiService` для работы с REST API
3. Создать класс `UserService` для работы с пользователями
4. Создать класс `ConfigService` для работы с конфигурацией
5. Создать класс `AccessControlService` для управления правами доступа
6. Создать класс `LoggerService` для унифицированного логирования

**Результат:**
- Все функции работы с API вынесены в сервисы
- Устранено дублирование кода
- Улучшена тестируемость

**Критерии приёмки:**
- [ ] Все сервисы созданы и протестированы
- [ ] Весь функционал работает как раньше
- [ ] Нет дублирования кода между сервисами

---

### Этап 2: Рефакторинг функций в классы
**Цель:** Преобразовать функции в методы классов с четкой ответственностью

**Задачи:**
1. Рефакторинг `auth-check.php` — выделение в класс `AuthService`
2. Рефакторинг `access-control-functions.php` — интеграция в `AccessControlService`
3. Выделение логики из `index.php` в контроллеры
4. Создание класса `DomainResolver` для получения домена портала
5. Создание класса `AdminChecker` для проверки статуса администратора

**Результат:**
- Все функции преобразованы в методы классов
- Четкое разделение ответственности
- Улучшена читаемость кода

**Критерии приёмки:**
- [ ] Все функции преобразованы в методы классов
- [ ] Весь функционал работает как раньше
- [ ] Код соответствует стандартам PSR-12

---

### Этап 3: Разделение логики и представления
**Цель:** Выделить шаблоны и создать контроллеры

**Задачи:**
1. Создать директорию `templates/` для HTML-шаблонов
2. Выделить HTML из `index.php` в шаблон
3. Выделить HTML из `token-analysis.php` в шаблон
4. Выделить HTML из `access-control.php` в шаблон
5. Создать контроллеры для каждой страницы
6. Создать базовый класс `BaseController` с общей логикой

**Результат:**
- Четкое разделение логики и представления
- Переиспользуемые шаблоны
- Упрощенная поддержка и изменение интерфейса

**Критерии приёмки:**
- [ ] Все HTML вынесены в шаблоны
- [ ] Созданы контроллеры для всех страниц
- [ ] Весь функционал работает как раньше
- [ ] Интерфейс выглядит идентично

---

### Этап 4: Унификация работы с API
**Цель:** Создать единый клиент для Bitrix24 API

**Задачи:**
1. Создать класс `Bitrix24Client` как обертку над CRest
2. Реализовать единую обработку ошибок API
3. Добавить кеширование ответов API (опционально)
4. Унифицировать логирование API-запросов
5. Создать интерфейс `ApiClientInterface` для возможности замены реализации

**Результат:**
- Единая точка входа для всех API-запросов
- Улучшенная обработка ошибок
- Возможность добавления кеширования и других оптимизаций

**Критерии приёмки:**
- [ ] Все API-запросы идут через `Bitrix24Client`
- [ ] Обработка ошибок унифицирована
- [ ] Весь функционал работает как раньше
- [ ] Логирование API-запросов работает корректно

---

### Этап 5: Оптимизация и документация
**Цель:** Финальная оптимизация и обновление документации

**Задачи:**
1. Оптимизация производительности (кеширование, батч-запросы)
2. Улучшение обработки ошибок
3. Добавление PHPDoc комментариев ко всем классам и методам
4. Обновление документации архитектуры
5. Создание миграционного гайда для перехода на новую структуру
6. Финальное тестирование всего функционала

**Результат:**
- Оптимизированный код
- Полная документация
- Гайд по миграции

**Критерии приёмки:**
- [ ] Все классы и методы задокументированы
- [ ] Документация архитектуры обновлена
- [ ] Весь функционал работает как раньше
- [ ] Производительность не ухудшилась (или улучшилась)

---

## Структура после рефакторинга

```
APP-B24/
├── src/                              # Исходный код
│   ├── Services/                      # Сервисный слой
│   │   ├── Bitrix24ApiService.php    # Работа с Bitrix24 API
│   │   ├── UserService.php            # Работа с пользователями
│   │   ├── ConfigService.php         # Работа с конфигурацией
│   │   ├── AccessControlService.php   # Управление правами доступа
│   │   ├── AuthService.php           # Авторизация
│   │   └── LoggerService.php          # Логирование
│   ├── Controllers/                   # Контроллеры
│   │   ├── BaseController.php         # Базовый контроллер
│   │   ├── IndexController.php        # Главная страница
│   │   ├── TokenAnalysisController.php # Анализ токена
│   │   ├── AccessControlController.php # Управление правами
│   │   └── InstallController.php      # Установка
│   ├── Clients/                       # Клиенты для внешних API
│   │   ├── Bitrix24Client.php         # Клиент Bitrix24 API
│   │   └── ApiClientInterface.php     # Интерфейс клиента
│   ├── Helpers/                       # Вспомогательные классы
│   │   ├── DomainResolver.php         # Получение домена портала
│   │   └── AdminChecker.php           # Проверка администратора
│   └── Exceptions/                    # Исключения
│       ├── Bitrix24ApiException.php   # Ошибки API
│       └── AccessDeniedException.php # Ошибки доступа
├── templates/                         # Шаблоны
│   ├── index.php                      # Главная страница
│   ├── token-analysis.php             # Анализ токена
│   ├── access-control.php             # Управление правами
│   ├── failure.php                    # Страница ошибки
│   └── config-error.php               # Ошибка конфигурации
├── config/                            # Конфигурация
│   ├── config.json                    # Конфигурация доступа
│   ├── access-config.json             # Конфигурация прав доступа
│   └── settings.json                  # Настройки приложения
├── logs/                              # Логи
├── public/                            # Публичные файлы
│   ├── index.php                      # Точка входа
│   ├── install.php                    # Установка
│   └── .htaccess                      # Настройки Apache
└── vendor/                            # Зависимости (если будут)
    └── crest.php                      # Библиотека CRest
```

---

## Детальный план этапов

### Этап 1: Выделение сервисного слоя

#### 1.1. Создание структуры директорий

**Файлы:**
- `APP-B24/src/Services/` — директория для сервисов
- `APP-B24/src/Services/Bitrix24ApiService.php` — сервис для работы с API
- `APP-B24/src/Services/UserService.php` — сервис для работы с пользователями
- `APP-B24/src/Services/ConfigService.php` — сервис для работы с конфигурацией
- `APP-B24/src/Services/AccessControlService.php` — сервис для управления правами
- `APP-B24/src/Services/LoggerService.php` — сервис для логирования

#### 1.2. Создание класса `Bitrix24ApiService`

**Методы:**
- `call(string $method, array $params = []): array` — вызов метода API
- `getCurrentUser(string $authId, string $domain): array|null` — получение текущего пользователя
- `getUser(int $userId, string $authId, string $domain): array|null` — получение пользователя по ID
- `getDepartment(int $departmentId, string $authId, string $domain): array|null` — получение отдела
- `getAllDepartments(string $authId, string $domain): array` — получение всех отделов
- `getAllUsers(string $authId, string $domain, ?string $search = null): array` — получение всех пользователей
- `checkIsAdmin(string $authId, string $domain): bool` — проверка статуса администратора

**Источники кода:**
- Функции из `index.php`: `getCurrentUserData()`, `getDepartmentData()`
- Функции из `token-analysis.php`: `getCurrentUserData()`
- Функции из `access-control-functions.php`: `getAllDepartments()`, `getAllUsers()`, `checkIsAdmin()`

#### 1.3. Создание класса `UserService`

**Методы:**
- `getCurrentUser(string $authId, string $domain): array|null` — получение текущего пользователя
- `getUserById(int $userId, string $authId, string $domain): array|null` — получение пользователя по ID
- `isAdmin(array $user, string $authId, string $domain): bool` — проверка статуса администратора
- `getUserDepartments(array $user): array` — получение отделов пользователя

#### 1.4. Создание класса `ConfigService`

**Методы:**
- `getIndexPageConfig(): array` — получение конфигурации главной страницы
- `getAccessConfig(): array` — получение конфигурации прав доступа
- `saveAccessConfig(array $config): array` — сохранение конфигурации прав доступа
- `getSettings(): array` — получение настроек приложения

**Источники кода:**
- Функции из `index.php`: `checkIndexPageConfig()`
- Функции из `access-control-functions.php`: `getAccessConfig()`, `saveAccessConfig()`

#### 1.5. Создание класса `AccessControlService`

**Методы:**
- `checkUserAccess(int $userId, array $userDepartments, string $authId, string $domain): bool` — проверка прав доступа
- `addDepartment(int $departmentId, string $departmentName, array $addedBy): array` — добавление отдела
- `removeDepartment(int $departmentId): array` — удаление отдела
- `addUser(int $userId, string $userName, string $userEmail, array $addedBy): array` — добавление пользователя
- `removeUser(int $userId): array` — удаление пользователя
- `toggleAccessControl(bool $enabled, array $updatedBy): array` — включение/выключение проверки

**Источники кода:**
- Функции из `access-control-functions.php`: все функции работы с правами доступа

#### 1.6. Создание класса `LoggerService`

**Методы:**
- `log(string $message, array $context = [], string $type = 'info'): void` — логирование
- `logError(string $message, array $context = []): void` — логирование ошибок
- `logAccessCheck(int $userId, array $userDepartments, string $result, string $reason): void` — логирование проверки доступа
- `logConfigCheck(string $message, array $context = []): void` — логирование проверки конфигурации

**Источники кода:**
- Функции логирования из всех файлов

---

### Этап 2: Рефакторинг функций в классы

#### 2.1. Рефакторинг `auth-check.php`

**Создать класс:** `APP-B24/src/Services/AuthService.php`

**Методы:**
- `checkBitrix24Auth(): bool` — проверка авторизации Bitrix24
- `isRequestFromBitrix24(): bool` — проверка, идет ли запрос из Bitrix24
- `redirectToFailure(): void` — редирект на страницу ошибки

**Изменения:**
- Преобразовать функции в методы класса
- Использовать `LoggerService` для логирования
- Использовать `ConfigService` для работы с настройками

#### 2.2. Рефакторинг `access-control-functions.php`

**Интеграция в:** `AccessControlService`

**Изменения:**
- Все функции из `access-control-functions.php` становятся методами `AccessControlService`
- Использовать `Bitrix24ApiService` для работы с API
- Использовать `LoggerService` для логирования

#### 2.3. Выделение логики из `index.php`

**Создать класс:** `APP-B24/src/Helpers/DomainResolver.php`

**Методы:**
- `resolveDomain(): string|null` — получение домена портала

**Создать класс:** `APP-B24/src/Helpers/AdminChecker.php`

**Методы:**
- `check(array $user, string $authId, string $domain): bool` — проверка статуса администратора

#### 2.4. Обновление существующих файлов

**Изменения в файлах:**
- `index.php` — использовать новые сервисы вместо функций
- `token-analysis.php` — использовать новые сервисы
- `access-control.php` — использовать новые сервисы
- `auth-check.php` — использовать `AuthService`

---

### Этап 3: Разделение логики и представления

#### 3.1. Создание директории шаблонов

**Структура:**
- `APP-B24/templates/` — директория для шаблонов
- `APP-B24/templates/layout.php` — базовый шаблон
- `APP-B24/templates/index.php` — шаблон главной страницы
- `APP-B24/templates/token-analysis.php` — шаблон анализа токена
- `APP-B24/templates/access-control.php` — шаблон управления правами
- `APP-B24/templates/failure.php` — шаблон страницы ошибки
- `APP-B24/templates/config-error.php` — шаблон ошибки конфигурации

#### 3.2. Создание контроллеров

**Создать классы:**
- `APP-B24/src/Controllers/BaseController.php` — базовый контроллер
- `APP-B24/src/Controllers/IndexController.php` — контроллер главной страницы
- `APP-B24/src/Controllers/TokenAnalysisController.php` — контроллер анализа токена
- `APP-B24/src/Controllers/AccessControlController.php` — контроллер управления правами
- `APP-B24/src/Controllers/InstallController.php` — контроллер установки

**Методы базового контроллера:**
- `render(string $template, array $data = []): void` — рендеринг шаблона
- `redirect(string $url): void` — редирект
- `json(array $data): void` — вывод JSON

#### 3.3. Выделение HTML из файлов

**Изменения:**
- `index.php` — только логика, HTML в шаблон
- `token-analysis.php` — только логика, HTML в шаблон
- `access-control.php` — только логика, HTML в шаблон

---

### Этап 4: Унификация работы с API

#### 4.1. Создание класса `Bitrix24Client`

**Создать класс:** `APP-B24/src/Clients/Bitrix24Client.php`

**Методы:**
- `call(string $method, array $params = []): array` — вызов метода API
- `callBatch(array $commands, int $halt = 0): array` — батч-запросы
- `refreshToken(): bool` — обновление токена

**Интерфейс:** `APP-B24/src/Clients/ApiClientInterface.php`

#### 4.2. Унификация обработки ошибок

**Создать классы исключений:**
- `APP-B24/src/Exceptions/Bitrix24ApiException.php` — ошибки API
- `APP-B24/src/Exceptions/AccessDeniedException.php` — ошибки доступа
- `APP-B24/src/Exceptions/ConfigException.php` — ошибки конфигурации

#### 4.3. Обновление сервисов

**Изменения:**
- `Bitrix24ApiService` использует `Bitrix24Client`
- Все сервисы используют единую обработку ошибок

---

### Этап 5: Оптимизация и документация

#### 5.1. Оптимизация производительности

**Задачи:**
- Добавить кеширование ответов API (опционально)
- Оптимизировать батч-запросы
- Улучшить обработку ошибок

#### 5.2. Документация

**Задачи:**
- Добавить PHPDoc ко всем классам и методам
- Обновить `DOCS/ARCHITECTURE/application-architecture.md`
- Создать `DOCS/GUIDES/refactoring-migration-guide.md`

#### 5.3. Финальное тестирование

**Задачи:**
- Протестировать весь функционал
- Проверить производительность
- Убедиться, что все работает как раньше

---

## Критерии успешного рефакторинга

### Функциональные требования
- ✅ Весь текущий функционал работает идентично
- ✅ Все страницы отображаются корректно
- ✅ Все проверки доступа работают
- ✅ Логирование работает корректно

### Технические требования
- ✅ Код соответствует стандартам PSR-12
- ✅ Нет дублирования кода
- ✅ Четкое разделение ответственности
- ✅ Улучшена тестируемость

### Документация
- ✅ Все классы и методы задокументированы
- ✅ Документация архитектуры обновлена
- ✅ Создан миграционный гайд

---

## Риски и митигация

### Риск 1: Потеря функциональности
**Митигация:**
- Поэтапный рефакторинг с тестированием на каждом этапе
- Сохранение старых файлов до завершения рефакторинга
- Тщательное тестирование после каждого этапа

### Риск 2: Ухудшение производительности
**Митигация:**
- Бенчмарки до и после рефакторинга
- Оптимизация критических участков
- Кеширование где возможно

### Риск 3: Сложность миграции
**Митигация:**
- Поэтапный подход
- Детальная документация изменений
- Поддержка обратной совместимости на переходный период

---

## Временные рамки

### Этап 1: Выделение сервисного слоя
**Оценка:** 2-3 дня

### Этап 2: Рефакторинг функций в классы
**Оценка:** 2-3 дня

### Этап 3: Разделение логики и представления
**Оценка:** 2-3 дня

### Этап 4: Унификация работы с API
**Оценка:** 1-2 дня

### Этап 5: Оптимизация и документация
**Оценка:** 1-2 дня

**Общая оценка:** 8-13 дней

---

## История правок

- **2025-12-20 20:00 (UTC+3, Брест):** Создан план рефакторинга на 5 этапов

---

**Статус:** План готов к реализации  
**Дата создания:** 2025-12-20 20:00 (UTC+3, Брест)

