# TASK-012: Очистка корневой директории APP-B24/

**Дата создания:** 2025-01-27 16:00 (UTC+3, Брест)  
**Статус:** Завершена  
**Приоритет:** Средний  
**Исполнитель:** Рефактор-менеджер / Системный администратор

---

## Описание

Очистка корневой директории `APP-B24/` от лишних файлов и реализация логики работы `index.php` как основной точки входа приложения. В корне должны остаться только:
- Точки входа приложения: `index.php`, `install.php`, `access-control.php`, `token-analysis.php`
- Конфигурационные JSON-файлы: `composer.json`, `config.json`, `settings.json`, `access-config.json`
- Служебные файлы: `.gitignore`, `.htaccess`, `README.md`

Все остальные файлы должны быть перемещены в соответствующие директории:
- `failure.php` → `public/failure.php`
- `config-error.php` → `templates/config-error.php`
- `test-*.php` → `tools/test-*.php`

### Логика работы index.php (основная точка входа):

1. **Проверка работоспособности приложения:**
   - Проверка существования собранных файлов Vue.js
   - Отображение информации о текущей авторизации

2. **Проверка авторизации Bitrix24:**
   - Если авторизация не прошла → редирект на `public/failure.php`
   - Если активен конфиг внешнего доступа → разрешить доступ без Bitrix24

3. **Проверка прав администратора:**
   - После успешной авторизации проверяется статус администратора
   - Если пользователь — администратор, отображаются две дополнительные кнопки:
     - **Проверка токена** → переход на `token-analysis.php`
     - **Функционал администрирования** → переход на `access-control.php`

4. **Загрузка Vue.js приложения:**
   - После всех проверок загружается Vue.js приложение на маршрут `/`

---

## Контекст

Согласно архитектуре проекта, корневая директория должна содержать только точки входа приложения и конфигурационные файлы. Все остальные файлы должны быть организованы в соответствующие директории (`src/`, `public/`, `tools/`, `templates/`).

**Ссылка на анализ:** `DOCS/ANALYSIS/2025-01-27-root-directory-cleanup-analysis.md`

---

## Текущее состояние корня APP-B24/

### ✅ Файлы, которые должны остаться в корне (9 файлов):

1. **`index.php`** — главная страница приложения ✓
2. **`install.php`** — страница установки ✓
3. **`access-control.php`** — точка входа для управления правами доступа ✓
4. **`token-analysis.php`** — точка входа для анализа токена ✓
5. **`composer.json`** — конфигурация Composer ✓
6. **`config.json`** — конфигурация приложения ✓
7. **`settings.json`** — настройки Bitrix24 ✓
8. **`access-config.json`** — конфигурация доступа ✓
9. **`.gitignore`**, **`.htaccess`**, **`README.md`** — служебные файлы ✓

### ⚠️ Файлы, которые должны быть перемещены:

1. **`failure.php`** → `public/failure.php`
   - **Использование:** Используется в `src/Services/AuthService.php` (строка 287-293) для редиректа при ошибках авторизации
   - **Действие:** Обновить путь в `AuthService.php::redirectToFailure()` после перемещения

2. **`config-error.php`** → `templates/config-error.php`
   - **Использование:** Не используется в коде (создан для TASK-004, но не интегрирован)
   - **Действие:** Переместить для будущего использования

### ❌ Файлы, которые должны быть перемещены в `tools/`:

1. **`test-bitrix24-api.php`** → `tools/test-bitrix24-api.php`
2. **`test-api.php`** → `tools/test-api.php`
3. **`test-autoload.php`** → `tools/test-autoload.php`
4. **`test-migration.php`** → `tools/test-migration.php`

---

## Модули и компоненты

### Файлы для перемещения:

- `failure.php` → `public/failure.php`
- `config-error.php` → `templates/config-error.php`
- `test-bitrix24-api.php` → `tools/test-bitrix24-api.php`
- `test-api.php` → `tools/test-api.php`
- `test-autoload.php` → `tools/test-autoload.php`
- `test-migration.php` → `tools/test-migration.php`

### Файлы для обновления:

- `src/Services/AuthService.php` — обновить путь к `failure.php` (строка ~287)
  ```php
  // Было:
  $failurePath = $scriptPath . '/failure.php';
  
  // Должно быть:
  $failurePath = $scriptPath . '/public/failure.php';
  ```

- `index.php` — реализовать логику работы основной точки входа:
  - Проверка конфига внешнего доступа
  - Отображение информации о текущей авторизации
  - Проверка прав администратора
  - Передача данных об администраторе в Vue.js

- `frontend/src/App.vue` (или главный компонент) — обновить интерфейс:
  - Отобразить информацию о текущей авторизации
  - Показать кнопки для администраторов (проверка токена, администрирование)

---

## Зависимости

- Зависит от структуры проекта и настройки веб-сервера
- Требует проверки всех ссылок на перемещаемые файлы

---

## Ступенчатые подзадачи

### Этап 1: Очистка корневой директории

1. **Перемещение служебных файлов:**
   ```bash
   mv APP-B24/failure.php APP-B24/public/failure.php
   mv APP-B24/config-error.php APP-B24/templates/config-error.php
   ```

2. **Перемещение тестовых файлов:**
   ```bash
   mv APP-B24/test-bitrix24-api.php APP-B24/tools/test-bitrix24-api.php
   mv APP-B24/test-api.php APP-B24/tools/test-api.php
   mv APP-B24/test-autoload.php APP-B24/tools/test-autoload.php
   mv APP-B24/test-migration.php APP-B24/tools/test-migration.php
   ```

3. **Обновление ссылок:**
   - Обновить путь к `failure.php` в `src/Services/AuthService.php::redirectToFailure()`
     - Найти строку: `$failurePath = $scriptPath . '/failure.php';`
     - Заменить на: `$failurePath = $scriptPath . '/public/failure.php';`

### Этап 2: Реализация логики index.php

4. **Обновление логики проверки авторизации в `index.php`:**
   - Добавить проверку конфига внешнего доступа (`config.json`)
   - Если внешний доступ активен → разрешить доступ без Bitrix24
   - Отобразить информацию о текущей авторизации (статус, пользователь)

5. **Добавление проверки прав администратора:**
   - После успешной авторизации вызвать `$userService->isAdmin()`
   - Передать информацию об администраторе в Vue.js приложение

6. **Обновление Vue.js приложения:**
   - В главном компоненте (`frontend/src/App.vue` или главной странице):
     - Отобразить информацию о текущей авторизации
     - Если пользователь — администратор, показать две кнопки:
       - **Проверка токена** → переход на `/token-analysis`
       - **Администрирование** → переход на `/access-control`
   - Использовать данные из `userStore` для проверки статуса администратора

7. **Проверка работоспособности:**
   - Проверить работу авторизации (должен работать редирект на `public/failure.php`)
   - Проверить работу с внешним доступом (если конфиг активен)
   - Проверить отображение кнопок для администраторов
   - Проверить работу всех точек входа (`index.php`, `install.php`, `access-control.php`, `token-analysis.php`)
   - Проверить работу тестовых скриптов в `tools/` (если нужно)

8. **Обновление документации:**
   - Обновить `README.md` с новой структурой корня
   - Обновить документацию в `DOCS/ARCHITECTURE/` о структуре проекта
   - Описать логику работы `index.php` в документации

---

## Технические требования

- Сохранить работоспособность всех функций приложения
- Обновить все ссылки на перемещаемые файлы
- Сохранить логику работы точек входа

---

## Критерии приёмки

### Очистка корневой директории:

- [ ] В корне `APP-B24/` остались только точки входа и конфиги:
  - [ ] `index.php`, `install.php`, `access-control.php`, `token-analysis.php`
  - [ ] `composer.json`, `config.json`, `settings.json`, `access-config.json`
  - [ ] `.gitignore`, `.htaccess`, `README.md`
- [ ] `failure.php` перемещён в `public/failure.php`
- [ ] `config-error.php` перемещён в `templates/config-error.php`
- [ ] Все `test-*.php` перемещены в `tools/`
- [ ] Обновлён путь к `failure.php` в `src/Services/AuthService.php`

### Логика работы index.php:

- [ ] `index.php` отображает информацию о текущей авторизации
- [ ] Проверка работоспособности приложения (существование собранных файлов Vue.js)
- [ ] Реализована проверка конфига внешнего доступа
- [ ] Если внешний доступ активен → разрешён доступ без Bitrix24
- [ ] После авторизации проверяется статус администратора
- [ ] Для администраторов отображаются две кнопки:
  - [ ] Кнопка "Проверка токена" → переход на `/token-analysis`
  - [ ] Кнопка "Администрирование" → переход на `/access-control`
- [ ] Данные об администраторе передаются в Vue.js приложение
- [ ] Приложение работает корректно после всех изменений
- [ ] Обновлена документация (`README.md` и `DOCS/`)

---

## Тестирование

1. **Проверка авторизации:**
   - Попытаться открыть `index.php` без авторизации Bitrix24
   - Должен произойти редирект на `public/failure.php`
   - Проверить работу с активным конфигом внешнего доступа (доступ без Bitrix24)

2. **Проверка отображения информации:**
   - Открыть `index.php` с валидной авторизацией Bitrix24
   - Проверить отображение информации о текущей авторизации
   - Проверить отображение информации о пользователе

3. **Проверка прав администратора:**
   - Открыть `index.php` с авторизацией администратора
   - Проверить отображение двух кнопок:
     - Кнопка "Проверка токена" → должна вести на `/token-analysis`
     - Кнопка "Администрирование" → должна вести на `/access-control`
   - Открыть `index.php` с авторизацией обычного пользователя
   - Проверить, что кнопки администратора не отображаются

4. **Проверка точек входа:**
   - Открыть `install.php` с параметрами установки
   - Открыть `access-control.php` с валидной авторизацией администратора
   - Открыть `token-analysis.php` с валидной авторизацией администратора

5. **Проверка тестовых скриптов:**
   - Запустить тестовые скрипты из `tools/` (если нужно)

---

## История правок

- 2025-01-27 16:00 (UTC+3, Брест): Создана задача
- 2025-01-27 16:30 (UTC+3, Брест): Добавлена логика работы index.php (проверка авторизации, прав администратора, внешний доступ)
- 2025-01-27 14:00 (UTC+3, Брест): Задача выполнена
  - Перемещены файлы: failure.php → public/, config-error.php → templates/, test-*.php → tools/
  - Обновлён путь к failure.php в AuthService.php
  - Реализована логика проверки внешнего доступа в index.php
  - Добавлена проверка прав администратора в index.php
  - Обновлено Vue.js приложение для отображения информации и кнопок администратора
  - Обновлена документация (README.md)

