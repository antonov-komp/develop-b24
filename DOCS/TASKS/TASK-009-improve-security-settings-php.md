# TASK-009: Улучшение безопасности settings.php через .htaccess

**Дата создания:** 2025-12-20 23:15 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vanilla JS)

---

## Описание

Улучшить безопасность файла `settings.php`, добавив защиту от прямого доступа через `.htaccess`. Файл содержит секретные данные (CLIENT_ID, CLIENT_SECRET) и должен быть защищен от прямого доступа через веб-сервер.

---

## Контекст

Файл `settings.php` содержит секретные данные:
- `C_REST_CLIENT_ID` — идентификатор приложения
- `C_REST_CLIENT_SECRET` — секретный ключ приложения

В настоящее время файл защищен только через `.gitignore` (не коммитится в Git), но не защищен от прямого доступа через веб-сервер через `.htaccess`.

**Ссылка на анализ:** `DOCS/ANALYSIS/2025-12-20-file-structure-analysis.md`

---

## Модули и компоненты

**Обновляемые файлы:**
- `APP-B24/.htaccess` — добавить правило для защиты `settings.php`

**Защищаемые файлы:**
- `APP-B24/settings.php` — файл с секретами

**Проверяемые файлы:**
- Убедиться, что `settings.php` используется только через `require_once` в PHP-коде
- Проверить, что нет прямых ссылок на файл в HTML/JavaScript

---

## Зависимости

**От каких задач зависит:**
- Нет (независимая задача)

**Какие задачи зависят от этой:**
- Нет

**Связь с другими задачами:**
- Связана с улучшением безопасности приложения

---

## Ступенчатые подзадачи

1. **Анализ текущей защиты:**
   - Проверить текущий `.htaccess` на наличие защиты `settings.php`
   - Убедиться, что файл не защищен от прямого доступа

2. **Добавление защиты в .htaccess:**
   - Добавить правило для блокировки прямого доступа к `settings.php`
   - Использовать синтаксис Apache для блокировки файла
   - Проверить совместимость с существующими правилами

3. **Тестирование защиты:**
   - Попытаться открыть `settings.php` напрямую через браузер
   - Должен вернуться код 403 Forbidden
   - Проверить, что файл доступен через `require_once` в PHP

4. **Проверка функциональности:**
   - Убедиться, что приложение работает корректно
   - Проверить, что `settings.php` подключается через `require_once` без проблем

5. **Обновление документации:**
   - Обновить `APP-B24/README.md` (если требуется)
   - Обновить анализ в `DOCS/ANALYSIS/2025-12-20-file-structure-analysis.md`

---

## Технические требования

**Правило для .htaccess:**
```apache
# Защита settings.php от прямого доступа
<FilesMatch "^(settings\.php)$">
    Order allow,deny
    Deny from all
</FilesMatch>
```

**Альтернативный вариант (для Apache 2.4+):**
```apache
# Защита settings.php от прямого доступа (Apache 2.4+)
<FilesMatch "^(settings\.php)$">
    Require all denied
</FilesMatch>
```

**Совместимость:**
- Правило должно работать с существующими правилами в `.htaccess`
- Не должно конфликтовать с защитой других файлов (`config.json`, `settings.json`)

---

## Критерии приёмки

- [ ] Правило добавлено в `.htaccess` для защиты `settings.php`
- [ ] Прямой доступ к `settings.php` через браузер блокируется (403 Forbidden)
- [ ] Файл доступен через `require_once` в PHP-коде
- [ ] Приложение работает корректно после добавления защиты
- [ ] Все страницы открываются без ошибок:
  - [ ] `index.php` работает
  - [ ] `install.php` работает
  - [ ] `access-control.php` работает
  - [ ] `token-analysis.php` работает
- [ ] Документация обновлена (если требуется)

---

## Тестирование

1. **Тестирование защиты:**
   - Открыть `https://your-domain.com/APP-B24/settings.php` в браузере
   - Должен вернуться код 403 Forbidden или страница с ошибкой доступа
   - Проверить в разных браузерах

2. **Тестирование функциональности:**
   - Открыть `index.php` в Bitrix24 — должна работать главная страница
   - Открыть `install.php` в Bitrix24 — должна работать установка
   - Проверить, что `settings.php` подключается через `require_once` без ошибок

3. **Проверка логов:**
   - Проверить логи Apache на наличие ошибок
   - Проверить логи приложения на наличие ошибок

4. **Проверка совместимости:**
   - Убедиться, что существующие правила в `.htaccess` работают
   - Проверить защиту других файлов (`config.json`, `settings.json`)

---

## Риски и митигация

**Риск:** Добавление правила может сломать функциональность, если `settings.php` используется нестандартным образом.

**Митигация:**
- Проверка, что файл используется только через `require_once`
- Тщательное тестирование всех страниц после добавления защиты
- Резервное копирование `.htaccess` перед изменениями

**Риск:** Правило может не работать на некоторых версиях Apache.

**Митигация:**
- Использовать совместимый синтаксис (поддержка старых и новых версий Apache)
- Тестирование на разных версиях Apache (если возможно)

---

## История правок

- 2025-12-20 23:15 (UTC+3, Брест): Создана задача на основе анализа структуры файлов

---

**Связанные документы:**
- `DOCS/ANALYSIS/2025-12-20-file-structure-analysis.md` — анализ структуры файлов
- `APP-B24/.htaccess` — текущий файл конфигурации Apache

