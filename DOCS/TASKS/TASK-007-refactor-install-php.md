# TASK-007: Рефакторинг install.php для использования AuthService

**Дата создания:** 2025-12-20 23:15 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (Vanilla JS)

---

## Описание

Рефакторить файл `install.php` для соответствия новой архитектуре приложения:
- Использовать `AuthService` напрямую вместо устаревшего `auth-check.php`
- Вынести HTML в шаблон `templates/install.php`
- Улучшить обработку ошибок

---

## Контекст

После завершения глобального рефакторинга (5 этапов) файл `install.php` остался с устаревшей архитектурой:
- Использует `auth-check.php` (устаревший файл-обертку)
- HTML смешан с PHP (не соответствует MVC)
- Нет использования сервисов из новой архитектуры

**Ссылка на анализ:** `DOCS/ANALYSIS/2025-12-20-file-structure-analysis.md`

---

## Модули и компоненты

**Обновляемые файлы:**
- `APP-B24/install.php` — точка входа (только инициализация)

**Создаваемые файлы:**
- `APP-B24/templates/install.php` — шаблон страницы установки

**Используемые сервисы:**
- `AuthService` — проверка авторизации
- `LoggerService` — логирование (опционально)

**Используемые библиотеки:**
- `crest.php` — библиотека CRest для установки приложения

---

## Зависимости

**От каких задач зависит:**
- Нет (независимая задача)

**Какие задачи зависят от этой:**
- TASK-008: Удаление устаревшего файла auth-check.php (после рефакторинга)

**Связь с другими задачами:**
- Связана с общим рефакторингом (этапы 1-5 завершены)

---

## Ступенчатые подзадачи

1. **Создание шаблона:**
   - Создать `templates/install.php` с HTML-разметкой
   - Вынести всю HTML-логику из `install.php` в шаблон
   - Использовать переменные для передачи данных в шаблон

2. **Рефакторинг install.php:**
   - Подключить `src/bootstrap.php` для инициализации сервисов
   - Использовать `AuthService` напрямую вместо `auth-check.php`
   - Оставить только логику инициализации и вызова CRest
   - Использовать шаблон для отображения

3. **Улучшение обработки ошибок:**
   - Добавить обработку исключений
   - Логирование ошибок через `LoggerService` (опционально)
   - Показ понятных сообщений об ошибках

4. **Тестирование:**
   - Проверить установку приложения в Bitrix24
   - Проверить обработку ошибок
   - Проверить отображение шаблона

---

## Технические требования

**Архитектура:**
- Использовать `AuthService` из `src/Services/AuthService.php`
- Использовать шаблоны из `templates/`
- Следовать паттерну MVC (как в других точках входа)

**Структура install.php:**
```php
<?php
// Подключение bootstrap
require_once(__DIR__ . '/src/bootstrap.php');

// Использование AuthService
if (!$authService->checkAuth(true)) {
    $authService->redirectToFailure();
}

// Логика установки через CRest
require_once(__DIR__ . '/crest.php');
$result = CRest::installApp();

// Отображение шаблона
include(__DIR__ . '/templates/install.php');
```

**Структура templates/install.php:**
```php
<?php
// Переменные: $result, $isRestOnly
?>
<!DOCTYPE html>
<html>
<head>
    <script src="//api.bitrix24.com/api/v1/"></script>
    <?php if ($result['install'] == true): ?>
    <script>
        BX24.init(function(){
            BX24.installFinish();
        });
    </script>
    <?php endif; ?>
</head>
<body>
    <?php if ($result['install'] == true): ?>
        installation has been finished
    <?php else: ?>
        installation error
    <?php endif; ?>
</body>
</html>
```

---

## Критерии приёмки

- [ ] Файл `install.php` использует `AuthService` напрямую (не через `auth-check.php`)
- [ ] HTML вынесен в шаблон `templates/install.php`
- [ ] Файл `install.php` содержит только логику инициализации
- [ ] Установка приложения работает корректно в Bitrix24
- [ ] Обработка ошибок реализована
- [ ] Код соответствует стандартам PSR-12
- [ ] Код соответствует новой архитектуре (MVC)

---

## Тестирование

1. **Тестирование установки:**
   - Удалить приложение из Bitrix24 (если установлено)
   - Установить приложение заново через Bitrix24
   - Проверить, что установка проходит успешно
   - Проверить, что токены сохраняются в `settings.json`

2. **Тестирование защиты:**
   - Попытаться открыть `install.php` напрямую (без параметров Bitrix24)
   - Должен произойти редирект на `failure.php`

3. **Тестирование шаблона:**
   - Проверить, что шаблон отображается корректно
   - Проверить, что JavaScript для завершения установки работает

---

## Риски и митигация

**Риск:** Изменение логики установки может сломать процесс установки.

**Митигация:**
- Сохранить всю логику работы с CRest без изменений
- Тщательное тестирование установки
- Резервное копирование текущего файла перед изменениями

---

## История правок

- 2025-12-20 23:15 (UTC+3, Брест): Создана задача на основе анализа структуры файлов

---

**Связанные документы:**
- `DOCS/ANALYSIS/2025-12-20-file-structure-analysis.md` — анализ структуры файлов
- `DOCS/PLAN/2025-12-20/refactoring-summary.md` — итоги рефакторинга
- `APP-B24/src/Services/AuthService.php` — сервис авторизации

