# Исправление инициализации SDK во время установки

**Дата:** 2025-12-29 09:45 (UTC+3, Брест)  
**Проблема:** SDK клиент инициализируется до создания settings.json при установке  
**Статус:** Исправлено

---

## Описание проблемы

При переустановке приложения через Bitrix24 (кнопка "Переустановить приложение") возникала ошибка:

```
Failed to initialize SDK client, {"exception":"Access token or domain not found in settings.json"}
```

**Причина:**
- `bootstrap.php` вызывается в начале `install.php`
- `bootstrap.php` сразу пытается инициализировать SDK клиент с токеном установщика
- Но `settings.json` ещё не создан, так как установка происходит позже в `install.php`
- Это вызывало ошибку, хотя установка продолжалась

**Влияние:**
- Ошибка в логах
- Возможные проблемы с отображением страницы установки
- Пользователь видит, что "ничего не происходит"

---

## Решение

Добавлена проверка в `bootstrap.php` для пропуска инициализации SDK во время установки:

```php
// Пропускаем инициализацию во время установки (install.php), так как settings.json ещё не создан
$isInstallPage = basename($_SERVER['PHP_SELF'] ?? '') === 'install.php';
$isInstallEvent = isset($_REQUEST['event']) && $_REQUEST['event'] == 'ONAPPINSTALL';
$isPlacementEvent = isset($_REQUEST['PLACEMENT']) && $_REQUEST['PLACEMENT'] == 'DEFAULT';

// Инициализируем только если не происходит установка
if (!$isInstallPage || (!$isInstallEvent && !$isPlacementEvent)) {
    try {
        $bitrix24Client->initializeWithInstallerToken();
        // ...
    } catch (\Exception $e) {
        // ...
    }
} else {
    // Во время установки не инициализируем SDK
    $logger->log('Skipping SDK initialization during installation', [...], 'info');
}
```

**Логика:**
1. Проверяем, является ли текущая страница `install.php`
2. Проверяем, происходит ли событие установки (ONAPPINSTALL или PLACEMENT)
3. Если это установка — пропускаем инициализацию SDK
4. После установки SDK инициализируется при следующем запросе

---

## Изменённые файлы

- `APP-B24/src/bootstrap.php` — добавлена проверка для пропуска инициализации SDK во время установки

---

## Проверка

После исправления:
- При установке SDK не инициализируется (нет ошибок)
- Страница установки отображается корректно
- После установки SDK инициализируется при следующем запросе

---

## Рекомендации

1. **Мониторинг:**
   - Проверить логи после переустановки приложения
   - Убедиться, что страница установки отображается корректно

2. **Тестирование:**
   - Переустановить приложение через Bitrix24
   - Проверить, что установка проходит без ошибок
   - Проверить, что приложение работает после установки

---

**История:**
- 2025-12-29 09:45 (UTC+3, Брест): Исправлена инициализация SDK во время установки



