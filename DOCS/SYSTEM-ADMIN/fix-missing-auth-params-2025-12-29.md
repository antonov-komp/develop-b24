# Исправление отсутствия параметров авторизации после установки

**Дата:** 2025-12-29 09:55 (UTC+3, Брест)  
**Проблема:** После установки приложение не получает параметры авторизации от Bitrix24  
**Статус:** В процессе диагностики

---

## Описание проблемы

После переустановки приложения через Bitrix24:

1. Установка проходит успешно (`settings.json` создаётся)
2. `BX24.installFinish()` вызывается
3. Bitrix24 пытается открыть приложение
4. Но в логах видно: `has_auth_params":false` и `is_authenticated":false`
5. Приложение показывает "Идет загрузка приложения" бесконечно

**Анализ логов nginx:**

```
POST /APP-B24/index.php?DOMAIN=develop.bitrix24.by&PROTOCOL=1&LANG=ru&APP_SID=...
```

Видно, что:
- Bitrix24 передаёт `APP_SID` (не `AUTH_ID`)
- Параметры передаются через POST и GET одновременно
- `DOMAIN` передаётся в query string

**Проблема:**
- В `index.php` проверка: `!empty($_REQUEST['AUTH_ID']) || !empty($_REQUEST['DOMAIN'])`
- Но `APP_SID` не учитывается в проверке `has_auth_params`
- Хотя в `VueAppService.php` правильно используется: `$_POST['AUTH_ID'] ?? $_GET['AUTH_ID'] ?? $_GET['APP_SID']`

---

## Решение

### 1. Добавлено детальное логирование параметров запроса

В `APP-B24/index.php` добавлено логирование всех параметров:

```php
$logger->log('Index page access check', [
    'script' => 'index.php',
    'has_auth_params' => !empty($_REQUEST['AUTH_ID']) || !empty($_REQUEST['APP_SID']) || !empty($_REQUEST['DOMAIN']),
    'has_auth_id' => !empty($_REQUEST['AUTH_ID']),
    'has_app_sid' => !empty($_REQUEST['APP_SID']),
    'has_domain' => !empty($_REQUEST['DOMAIN']),
    'request_method' => $_SERVER['REQUEST_METHOD'] ?? 'UNKNOWN',
    'query_string' => $_SERVER['QUERY_STRING'] ?? '',
    'post_data_keys' => !empty($_POST) ? array_keys($_POST) : [],
    'get_data_keys' => !empty($_GET) ? array_keys($_GET) : [],
    'timestamp' => date('Y-m-d H:i:s')
], 'info');
```

**Цель:**
- Понять, какие именно параметры передаёт Bitrix24 после установки
- Определить, почему параметры не доходят до приложения
- Проверить, правильно ли обрабатываются POST и GET параметры

---

## Диагностика

После добавления логирования нужно:

1. **Переустановить приложение** в Bitrix24
2. **Проверить логи** `APP-B24/logs/info-2025-12-29.log`:
   - Какие параметры передаются?
   - Есть ли `AUTH_ID`, `APP_SID`, `DOMAIN`?
   - Какой метод запроса (GET/POST)?

3. **Проверить консоль браузера:**
   - Есть ли ошибки JavaScript?
   - Загружаются ли статические файлы?
   - Что показывает `BX24.init()`?

---

## Возможные причины

1. **Bitrix24 передаёт параметры через POST, но они не читаются:**
   - Проверить `$_POST` в логах
   - Возможно, нужно использовать `php://input`

2. **Параметры передаются, но не обрабатываются:**
   - Проверить логику в `VueAppService.php`
   - Убедиться, что `APP_SID` используется как `AUTH_ID`

3. **Проблема с загрузкой Vue.js:**
   - Проверить, загружаются ли файлы `/APP-B24/public/dist/assets/`
   - Проверить консоль браузера на ошибки

---

## Изменённые файлы

- `APP-B24/index.php` — добавлено детальное логирование параметров запроса

---

## Следующие шаги

1. Переустановить приложение
2. Проверить логи на наличие параметров
3. На основе логов определить причину проблемы
4. Исправить обработку параметров, если необходимо

---

**История:**
- 2025-12-29 09:55 (UTC+3, Брест): Добавлено детальное логирование параметров запроса




