# TASK-000: Миграция с CRest на b24phpsdk (Обзор)

**Дата создания:** 2025-12-20 19:48 (UTC+3, Брест)  
**Статус:** В работе  
**Приоритет:** Критический  
**Исполнитель:** Bitrix24 Программист (Vanilla JS)

---

## Описание

Глобальная задача по миграции бэкенда с устаревшей библиотеки CRest на официальный Bitrix24 PHP SDK (b24phpsdk). Это нулевой этап рефакторинга, который должен быть выполнен перед миграцией на Vue.js.

---

## Контекст

### Текущее состояние

- **Используется:** CRest (версия 1.36, устаревшая)
- **Проблемы:**
  - Нет активной поддержки
  - Отсутствие автокомплита методов
  - Ручное управление токенами
  - Ограниченная типизация

### Цель миграции

- **Переход на:** b24phpsdk (официальный SDK)
- **Преимущества:**
  - Активная поддержка от Bitrix24
  - Автокомплит и типизация
  - Автоматическое управление токенами
  - Объектно-ориентированный подход

---

## Детализированный план этапов

### Этап 1: Установка и настройка b24phpsdk

**Задача:** [TASK-001-install-b24phpsdk.md](TASK-001-install-b24phpsdk.md)

**Подэтапы:**
1. **Установка через Composer**
   - Создание `composer.json`
   - Установка b24phpsdk
   - Проверка зависимостей

2. **Настройка автозагрузки**
   - Обновление `bootstrap.php`
   - Подключение Composer autoload
   - Проверка загрузки классов

**Результат:** b24phpsdk установлен и готов к использованию

---

### Этап 2: Создание Bitrix24SdkClient

**Задача:** [TASK-002-create-sdk-client.md](TASK-002-create-sdk-client.md)

**Подэтапы:**
1. **Создание нового клиента**
   - Файл `src/Clients/Bitrix24SdkClient.php`
   - Реализация `ApiClientInterface`
   - Инициализация с токеном установщика
   - Инициализация с токеном пользователя
   - Инициализация с вебхуком

2. **Реализация методов**
   - Метод `call()` для API вызовов
   - Метод `callBatch()` для batch-запросов
   - Обработка ошибок
   - Логирование операций

3. **Тестирование клиента**
   - Проверка инициализации
   - Проверка API вызовов
   - Проверка batch-запросов

**Результат:** Новый клиент создан и протестирован

---

### Этап 3: Обновление Bitrix24ApiService

**Задача:** [TASK-003-update-api-service.md](TASK-003-update-api-service.md)

**Подэтапы:**
1. **Замена клиента**
   - Замена `Bitrix24Client` на `Bitrix24SdkClient`
   - Обновление конструктора
   - Обновление зависимостей

2. **Обновление методов**
   - Метод `getCurrentUser()` через SDK
   - Метод `getUser()` через SDK
   - Метод `getAllDepartments()` через SDK
   - Метод `getAllUsers()` через SDK
   - Удаление прямых curl-вызовов

3. **Тестирование сервиса**
   - Проверка всех методов
   - Проверка обработки ошибок
   - Проверка логирования

**Результат:** Bitrix24ApiService использует новый SDK клиент

---

### Этап 4: Миграция установки приложения

**Задача:** [TASK-004-migrate-install.md](TASK-004-migrate-install.md)

**Подэтапы:**
1. **Обновление install.php**
   - Удаление `CRest::installApp()`
   - Реализация установки через SDK
   - Обработка событий установки
   - Сохранение настроек в `settings.json`

2. **Обновление шаблона установки**
   - Обновление `templates/install.php`
   - Удаление упоминаний CRest
   - Обновление документации

3. **Тестирование установки**
   - Проверка установки через ONAPPINSTALL
   - Проверка установки через PLACEMENT
   - Проверка сохранения настроек

**Результат:** Установка приложения работает через SDK

---

### Этап 5: Обновление bootstrap и DI

**Задача:** [TASK-005-update-bootstrap.md](TASK-005-update-bootstrap.md)

**Подэтапы:**
1. **Обновление bootstrap.php**
   - Замена `Bitrix24Client` на `Bitrix24SdkClient`
   - Инициализация нового клиента
   - Обновление зависимостей сервисов

2. **Обновление контроллеров**
   - IndexController
   - AccessControlController
   - TokenAnalysisController
   - AuthService

3. **Удаление require_once crest.php**
   - Поиск всех использований
   - Удаление подключений
   - Проверка работоспособности

**Результат:** Все компоненты используют новый SDK клиент

---

### Этап 6: Тестирование миграции

**Задача:** [TASK-006-test-migration.md](TASK-006-test-migration.md)

**Подэтапы:**
1. **Функциональное тестирование**
   - Проверка всех API вызовов
   - Проверка batch-запросов
   - Проверка работы с токенами
   - Проверка обработки ошибок

2. **Интеграционное тестирование**
   - Тестирование главной страницы
   - Тестирование управления правами
   - Тестирование анализа токена
   - Тестирование установки

3. **Проверка производительности**
   - Сравнение времени выполнения
   - Проверка использования памяти
   - Проверка логирования

**Результат:** Миграция протестирована и работает корректно

---

### Этап 7: Удаление CRest и очистка

**Задача:** [TASK-007-remove-crest.md](TASK-007-remove-crest.md)

**Подэтапы:**
1. **Удаление файлов CRest**
   - Удаление `crest.php`
   - Удаление `settings.php` (если не нужен)
   - Проверка зависимостей

2. **Очистка кода**
   - Удаление комментариев о CRest
   - Обновление документации
   - Обновление README

3. **Финальная проверка**
   - Проверка работоспособности
   - Проверка отсутствия упоминаний CRest
   - Обновление истории изменений

**Результат:** CRest полностью удален, проект использует только b24phpsdk

---

## Зависимости между этапами

```
TASK-001 (Установка)
    ↓
TASK-002 (Создание клиента)
    ↓
TASK-003 (Обновление сервиса)
    ↓
TASK-004 (Миграция установки)
    ↓
TASK-005 (Обновление bootstrap)
    ↓
TASK-006 (Тестирование)
    ↓
TASK-007 (Очистка)
```

**Важно:** Этапы выполняются последовательно, так как каждый зависит от предыдущего.

---

## Критерии завершения всей миграции

- [ ] b24phpsdk установлен и работает
- [ ] Bitrix24SdkClient создан и протестирован
- [ ] Bitrix24ApiService использует новый клиент
- [ ] Установка приложения работает через SDK
- [ ] Все контроллеры и сервисы обновлены
- [ ] Все тесты пройдены успешно
- [ ] CRest полностью удален
- [ ] Документация обновлена

---

## Риски и митигация

### Риск 1: Несовместимость API
**Митигация:** Тщательное тестирование всех методов, проверка документации SDK

### Риск 2: Проблемы с токенами
**Митигация:** Сохранение старого кода до полного тестирования, возможность отката

### Риск 3: Производительность
**Митигация:** Сравнительное тестирование, оптимизация при необходимости

---

## История правок

- **2025-12-20 19:48 (UTC+3, Брест):** Создан обзорный документ с детализацией этапов миграции

---

**Связанные документы:**
- [DOCS/REFACTOR/crest-to-b24phpsdk-migration.md](../../crest-to-b24phpsdk-migration.md) — детальный план миграции
- [DOCS/REFACTOR/migration-plan.md](../../migration-plan.md) — общий план рефакторинга

---

**Версия документа:** 1.0  
**Последнее обновление:** 2025-12-20 19:48 (UTC+3, Брест)

