# TASK-005: Обновление bootstrap и DI

**Дата создания:** 2025-12-20 19:48 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Критический  
**Исполнитель:** Bitrix24 Программист (Vanilla JS)

---

## Описание

Обновление `bootstrap.php` и всех контроллеров для использования нового `Bitrix24SdkClient` вместо `Bitrix24Client`. Удаление всех `require_once('crest.php')` из проекта.

---

## Контекст

**Часть задачи:** TASK-000 (Миграция CRest → b24phpsdk)  
**Зависит от:** TASK-002, TASK-003, TASK-004  
**Зависимости от этой задачи:** TASK-006 (Тестирование миграции)

**Цель:** Завершить миграцию, обновив все места, где используется старый клиент.

---

## Модули и компоненты

**Обновляемые файлы:**
- `APP-B24/src/bootstrap.php` — инициализация сервисов
- `APP-B24/src/Controllers/IndexController.php`
- `APP-B24/src/Controllers/AccessControlController.php`
- `APP-B24/src/Controllers/TokenAnalysisController.php`
- `APP-B24/src/Services/AuthService.php`
- Все файлы с `require_once('crest.php')`

---

## Зависимости

**От каких задач зависит:**
- TASK-002 (Создание Bitrix24SdkClient)
- TASK-003 (Обновление Bitrix24ApiService)
- TASK-004 (Миграция установки)

**Какие задачи зависят от этой:**
- TASK-006 (Тестирование миграции)

---

## Ступенчатые подзадачи

### 1. Поиск всех использований CRest

1. **Найти все файлы с `require_once('crest.php')`:**
   ```bash
   grep -r "require_once.*crest.php" APP-B24/
   ```

2. **Найти все файлы с `CRest::`:**
   ```bash
   grep -r "CRest::" APP-B24/
   ```

3. **Составить список файлов для обновления**

### 2. Обновление bootstrap.php

1. **Открыть `APP-B24/src/bootstrap.php`**

2. **Найти создание Bitrix24Client:**
   ```php
   // Было:
   $bitrix24Client = new App\Clients\Bitrix24Client($logger);
   ```

3. **Заменить на Bitrix24SdkClient:**
   ```php
   // Стало:
   $bitrix24Client = new App\Clients\Bitrix24SdkClient($logger);
   $bitrix24Client->initializeWithInstallerToken();
   ```

4. **Обновить use-директивы:**
   ```php
   use App\Clients\Bitrix24SdkClient; // Вместо Bitrix24Client
   ```

5. **Удалить `require_once('crest.php')` (если есть)**

### 3. Обновление контроллеров

1. **IndexController:**
   - Удалить `require_once('crest.php')`
   - Проверить, что использует сервисы (не напрямую клиент)

2. **AccessControlController:**
   - Удалить `require_once('crest.php')`
   - Проверить использование сервисов

3. **TokenAnalysisController:**
   - Удалить `require_once('crest.php')`
   - Проверить использование сервисов

### 4. Обновление AuthService

1. **Открыть `APP-B24/src/Services/AuthService.php`**

2. **Удалить `require_once('crest.php')`**

3. **Проверить использование сервисов:**
   - Должен использовать Bitrix24ApiService
   - Не должен напрямую использовать клиент

### 5. Удаление require_once из всех файлов

1. **Для каждого файла из списка:**
   - Удалить `require_once(__DIR__ . '/../../crest.php');`
   - Удалить `require_once(__DIR__ . '/../crest.php');`
   - Удалить другие варианты

2. **Проверить, что файлы работают:**
   - Запустить тесты
   - Проверить логи на ошибки

### 6. Обновление точек входа

1. **index.php:**
   - Проверить, что использует bootstrap
   - Убедиться, что нет прямых вызовов CRest

2. **access-control.php:**
   - Проверить использование контроллеров
   - Убедиться, что нет прямых вызовов CRest

3. **token-analysis.php:**
   - Проверить использование контроллеров
   - Убедиться, что нет прямых вызовов CRest

### 7. Финальная проверка

1. **Повторный поиск CRest:**
   ```bash
   grep -r "CRest" APP-B24/src/
   # Должен вернуть пустой результат (или только в комментариях)
   ```

2. **Повторный поиск require_once crest:**
   ```bash
   grep -r "crest.php" APP-B24/
   # Должен вернуть пустой результат
   ```

3. **Проверка работоспособности:**
   - Запустить все страницы
   - Проверить логи

---

## Технические требования

- **Совместимость:** Все должно работать как раньше
- **Зависимости:** Правильная инициализация всех сервисов
- **Очистка:** Полное удаление зависимостей от CRest

---

## Критерии приёмки

- [ ] bootstrap.php обновлен для использования Bitrix24SdkClient
- [ ] Bitrix24SdkClient инициализируется с токеном установщика
- [ ] Все контроллеры обновлены (удалены require_once crest.php)
- [ ] AuthService обновлен (удален require_once crest.php)
- [ ] Все require_once('crest.php') удалены из проекта
- [ ] Все прямые вызовы CRest удалены
- [ ] Поиск CRest не находит использований (кроме комментариев)
- [ ] Все страницы работают корректно
- [ ] Логи не содержат ошибок
- [ ] Код соответствует стандартам PSR-12

---

## Тестирование

### 1. Проверка поиска CRest
```bash
grep -r "CRest" APP-B24/src/
# Должен вернуть пустой результат
```

### 2. Проверка поиска require_once crest
```bash
grep -r "crest.php" APP-B24/
# Должен вернуть пустой результат
```

### 3. Тест главной страницы
```bash
# Открыть index.php в браузере
# Должна работать без ошибок
```

### 4. Тест управления правами
```bash
# Открыть access-control.php в браузере
# Должна работать без ошибок
```

### 5. Тест анализа токена
```bash
# Открыть token-analysis.php в браузере
# Должна работать без ошибок
```

---

## Риски и митигация

### Риск 1: Пропущенные использования CRest
**Митигация:** Тщательный поиск, проверка всех файлов

### Риск 2: Проблемы с инициализацией
**Митигация:** Тестирование всех страниц, проверка логов

### Риск 3: Нарушение зависимостей
**Митигация:** Проверка порядка инициализации, тестирование

---

## История правок

- **2025-12-20 19:48 (UTC+3, Брест):** Создана задача на обновление bootstrap

---

**Связанные документы:**
- [TASK-000-crest-to-b24phpsdk-overview.md](TASK-000-crest-to-b24phpsdk-overview.md) — обзор миграции
- [TASK-002-create-sdk-client.md](TASK-002-create-sdk-client.md) — создание SDK клиента
- [TASK-003-update-api-service.md](TASK-003-update-api-service.md) — обновление API сервиса

---

**Версия документа:** 1.0  
**Последнее обновление:** 2025-12-20 19:48 (UTC+3, Брест)

