# TASK-003: Обновление Bitrix24ApiService

**Дата создания:** 2025-12-20 19:48 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Критический  
**Исполнитель:** Bitrix24 Программист (Vanilla JS)

---

## Описание

Обновление `Bitrix24ApiService` для использования нового `Bitrix24SdkClient` вместо `Bitrix24Client` (который использует CRest). Также удаление прямых curl-вызовов и замена их на вызовы через SDK.

---

## Контекст

**Часть задачи:** TASK-000 (Миграция CRest → b24phpsdk)  
**Зависит от:** TASK-002 (Создание Bitrix24SdkClient)  
**Зависимости от этой задачи:** TASK-005 (Обновление bootstrap)

**Цель:** Перевести все вызовы Bitrix24 API в `Bitrix24ApiService` на использование нового SDK клиента.

---

## Модули и компоненты

**Обновляемые файлы:**
- `APP-B24/src/Services/Bitrix24ApiService.php` — основной сервис

**Используемые классы:**
- `App\Clients\Bitrix24SdkClient` — новый клиент (вместо Bitrix24Client)
- `App\Services\LoggerService` — логирование
- `App\Exceptions\Bitrix24ApiException` — исключения

---

## Зависимости

**От каких задач зависит:**
- TASK-002 (Создание Bitrix24SdkClient) — необходим новый клиент

**Какие задачи зависят от этой:**
- TASK-005 (Обновление bootstrap) — использует обновленный сервис

---

## Ступенчатые подзадачи

### 1. Анализ текущего Bitrix24ApiService

1. **Открыть `APP-B24/src/Services/Bitrix24ApiService.php`**

2. **Изучить текущую реализацию:**
   - Какие методы используют Bitrix24Client
   - Какие методы используют прямые curl-вызовы
   - Как обрабатываются ошибки
   - Как работает логирование

3. **Составить список методов для обновления:**
   - `call()` — использует Bitrix24Client
   - `getCurrentUser()` — использует curl напрямую
   - `getUser()` — использует Bitrix24Client
   - `getAllDepartments()` — использует Bitrix24Client
   - `getAllUsers()` — использует Bitrix24Client
   - Другие методы

### 2. Обновление конструктора

1. **Заменить тип параметра:**
   ```php
   // Было:
   protected Bitrix24Client $client;
   
   // Стало:
   protected Bitrix24SdkClient $client;
   ```

2. **Обновить конструктор:**
   ```php
   public function __construct(Bitrix24SdkClient $client, LoggerService $logger)
   ```

3. **Обновить use-директивы:**
   ```php
   use App\Clients\Bitrix24SdkClient; // Вместо Bitrix24Client
   ```

### 3. Обновление метода call()

1. **Проверить текущую реализацию**

2. **Убедиться, что метод работает с новым клиентом:**
   - Новый клиент имеет тот же интерфейс
   - Формат ответов совместим
   - Обработка ошибок работает

3. **Обновить комментарии (если нужно)**

### 4. Обновление метода getCurrentUser()

1. **Найти метод `getCurrentUser()`**

2. **Удалить прямые curl-вызовы:**
   - Удалить curl_init, curl_setopt, curl_exec
   - Удалить обработку curl ошибок

3. **Заменить на вызов через SDK:**
   ```php
   public function getCurrentUser(string $authId, string $domain): ?array
   {
       // Инициализируем клиент с токеном пользователя
       $this->client->initializeWithUserToken($authId, $domain);
       
       // Вызываем через SDK
       $result = $this->client->call('user.current', []);
       
       if (isset($result['error']) || !isset($result['result'])) {
           return null;
       }
       
       return $result['result'];
   }
   ```

4. **Сохранить логирование:**
   - Логирование запроса
   - Логирование ответа
   - Логирование ошибок

### 5. Обновление остальных методов

1. **Обновить `getUser()`:**
   - Убедиться, что использует SDK клиент
   - Проверить обработку ошибок

2. **Обновить `getAllDepartments()`:**
   - Использовать SDK клиент
   - Проверить формат ответа

3. **Обновить `getAllUsers()`:**
   - Использовать SDK клиент
   - Проверить формат ответа

4. **Обновить другие методы (если есть):**
   - Проверить все методы, использующие Bitrix24Client
   - Заменить на использование SDK клиента

### 6. Удаление require_once crest.php

1. **Найти `require_once(__DIR__ . '/../../crest.php');`**

2. **Удалить строку**

3. **Проверить, что нет других использований CRest**

### 7. Тестирование сервиса

1. **Создать тестовый скрипт `APP-B24/test-api-service.php`**

2. **Протестировать все методы:**
   - `call()`
   - `getCurrentUser()`
   - `getUser()`
   - `getAllDepartments()`
   - `getAllUsers()`

3. **Проверить обработку ошибок**

4. **Проверить логирование**

---

## Технические требования

- **Совместимость:** Все методы должны работать так же, как раньше
- **Формат ответов:** Должен быть идентичен предыдущей версии
- **Обработка ошибок:** Должна быть идентична предыдущей версии
- **Логирование:** Должно работать как раньше

---

## Критерии приёмки

- [ ] Конструктор обновлен для использования Bitrix24SdkClient
- [ ] Метод `call()` работает с новым клиентом
- [ ] Метод `getCurrentUser()` использует SDK вместо curl
- [ ] Метод `getUser()` работает корректно
- [ ] Метод `getAllDepartments()` работает корректно
- [ ] Метод `getAllUsers()` работает корректно
- [ ] Все прямые curl-вызовы удалены
- [ ] `require_once crest.php` удален
- [ ] Логирование работает корректно
- [ ] Обработка ошибок работает корректно
- [ ] Тестовый скрипт подтверждает работоспособность всех методов
- [ ] Код соответствует стандартам PSR-12

---

## Тестирование

### 1. Тест метода call()
```php
$result = $apiService->call('user.current', []);
// Должен вернуть результат в правильном формате
```

### 2. Тест метода getCurrentUser()
```php
$user = $apiService->getCurrentUser($authId, $domain);
// Должен вернуть данные пользователя или null
```

### 3. Тест метода getUser()
```php
$user = $apiService->getUser($userId, $authId, $domain);
// Должен вернуть данные пользователя или null
```

### 4. Тест обработки ошибок
```php
$result = $apiService->call('nonexistent.method', []);
// Должна быть корректная обработка ошибки
```

---

## Риски и митигация

### Риск 1: Изменение формата ответов
**Митигация:** Тщательное тестирование, сравнение с предыдущей версией

### Риск 2: Проблемы с инициализацией клиента
**Митигация:** Проверка всех сценариев использования токенов

### Риск 3: Потеря функциональности
**Митигация:** Детальное тестирование всех методов

---

## История правок

- **2025-12-20 19:48 (UTC+3, Брест):** Создана задача на обновление Bitrix24ApiService

---

**Связанные документы:**
- [TASK-000-crest-to-b24phpsdk-overview.md](TASK-000-crest-to-b24phpsdk-overview.md) — обзор миграции
- [TASK-002-create-sdk-client.md](TASK-002-create-sdk-client.md) — создание SDK клиента

---

**Версия документа:** 1.0  
**Последнее обновление:** 2025-12-20 19:48 (UTC+3, Брест)


