# Анализ модуля "Администрирование" (Access Control)

**Дата создания:** 2025-12-21 16:00 (UTC+3, Брест)  
**Версия:** 1.0  
**Статус:** Актуально  
**Автор:** Технический писатель

---

## Описание модуля

Модуль "Администрирование" (Access Control) — это система управления правами доступа к приложению Bitrix24. Модуль позволяет администраторам портала настраивать, какие отделы и пользователи имеют доступ к приложению.

### Основные возможности

1. **Управление правами доступа**
   - Включение/выключение проверки прав доступа
   - Управление списком отделов с доступом
   - Управление списком пользователей с доступом

2. **Проверка доступа**
   - Автоматическая проверка статуса администратора
   - Проверка принадлежности пользователя к разрешённым отделам
   - Проверка наличия пользователя в списке разрешённых

3. **Логирование**
   - Все операции управления правами логируются
   - Проверки доступа фиксируются в логах

---

## Архитектура модуля

### Слои архитектуры

Модуль построен по **модульной архитектуре версии 3.0** с разделением на слои:

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Vue.js)                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  AccessControlPage.vue (UI компонент)              │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  accessControlStore.js (Pinia store)                │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP/JSON
┌─────────────────────────────────────────────────────────────┐
│                    Backend (PHP)                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  api/routes/access-control.php (API endpoint)        │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  AccessControlService (бизнес-логика)                │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  ConfigService (работа с конфигурацией)               │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  UserService (проверка прав администратора)          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                    Хранение данных                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  access-config.json (JSON конфигурация)               │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## Компоненты модуля

### 1. Backend компоненты

#### 1.1. AccessControlService

**Путь:** `APP-B24/src/Services/AccessControlService.php`

**Назначение:** Сервис бизнес-логики для управления правами доступа.

**Основные методы:**

```php
// Проверка прав доступа пользователя
public function checkUserAccess(
    int $userId, 
    array $userDepartments, 
    string $authId, 
    string $domain
): bool

// Добавление отдела в список доступа
public function addDepartment(
    int $departmentId, 
    string $departmentName, 
    array $addedBy
): array

// Удаление отдела из списка доступа
public function removeDepartment(int $departmentId): bool

// Добавление пользователя в список доступа
public function addUser(
    int $userId, 
    string $userName, 
    ?string $userEmail, 
    array $addedBy
): array

// Удаление пользователя из списка доступа
public function removeUser(int $userId): bool

// Включение/выключение проверки прав доступа
public function toggleAccessControl(
    bool $enabled, 
    array $updatedBy
): array
```

**Логика проверки доступа:**

1. **Проверка статуса администратора**
   - Если пользователь — администратор → доступ разрешён
   - Используется `UserService::isAdmin()`

2. **Проверка включения системы**
   - Если `access_control.enabled === false` → доступ разрешён всем

3. **Проверка отделов**
   - Если отдел пользователя есть в списке `departments` → доступ разрешён

4. **Проверка пользователей**
   - Если пользователь есть в списке `users` → доступ разрешён

5. **Отказ в доступе**
   - Если ни одно условие не выполнено → доступ запрещён

**Зависимости:**
- `ConfigService` — для работы с конфигурацией
- `Bitrix24ApiService` — для работы с Bitrix24 API
- `UserService` — для проверки прав администратора
- `LoggerService` — для логирования операций

#### 1.2. ConfigService

**Путь:** `APP-B24/src/Services/ConfigService.php`

**Назначение:** Управление конфигурационными файлами приложения.

**Методы для работы с правами доступа:**

```php
// Получение конфигурации прав доступа
public function getAccessConfig(): array

// Сохранение конфигурации прав доступа
public function saveAccessConfig(array $config): array
```

**Структура конфигурации:**

```json
{
    "access_control": {
        "enabled": true,
        "departments": [
            {
                "id": 1,
                "name": "Отдел продаж",
                "added_at": "2025-12-20 20:43:10",
                "added_by": {
                    "id": "1",
                    "name": "Марк Антонов"
                }
            }
        ],
        "users": [
            {
                "id": 123,
                "name": "Иван Иванов",
                "email": "ivan@example.com",
                "added_at": "2025-12-20 20:43:10",
                "added_by": {
                    "id": "1",
                    "name": "Марк Антонов"
                }
            }
        ],
        "last_updated": "2025-12-20 20:43:10",
        "updated_by": {
            "id": "1",
            "name": "Марк Антонов"
        }
    }
}
```

**Файл конфигурации:** `APP-B24/access-config.json`

#### 1.3. UserService

**Путь:** `APP-B24/src/Services/UserService.php`

**Назначение:** Работа с пользователями и проверка прав администратора.

**Метод проверки администратора:**

```php
public function isAdmin(array $user, string $authId, string $domain): bool
```

**Логика проверки:**

1. **Проверка поля `ADMIN`**
   - Если `ADMIN === 'Y'` или `ADMIN === 1` или `ADMIN === true` → администратор

2. **Проверка поля `IS_ADMIN`**
   - Если `IS_ADMIN === 'Y'` или `IS_ADMIN === 1` → администратор

3. **Проверка через Bitrix24 API**
   - Используется метод `user.admin` через `Bitrix24ApiService::checkIsAdmin()`
   - Документация: https://context7.com/bitrix24/rest/user.admin

#### 1.4. API Endpoint

**Путь:** `APP-B24/api/routes/access-control.php`

**Назначение:** REST API для управления правами доступа.

**Endpoints:**

| Метод | Путь | Описание |
|-------|------|----------|
| `GET` | `/api/access-control` | Получение конфигурации прав доступа |
| `POST` | `/api/access-control/departments` | Добавление отдела |
| `POST` | `/api/access-control/users` | Добавление пользователя |
| `DELETE` | `/api/access-control/departments/{id}` | Удаление отдела |
| `DELETE` | `/api/access-control/users/{id}` | Удаление пользователя |

**Параметры запроса:**

- `AUTH_ID` (или `APP_SID`) — токен авторизации (query или POST)
- `DOMAIN` — домен портала (query или POST)

**Безопасность:**

1. **Проверка авторизации**
   - Используется middleware `auth.php`
   - Проверка наличия `AUTH_ID` и `DOMAIN`

2. **Проверка прав администратора**
   - Только администраторы могут управлять правами доступа
   - Используется `UserService::isAdmin()`

**Примеры запросов:**

```bash
# Получение конфигурации
GET /api/access-control?AUTH_ID=xxx&DOMAIN=example.bitrix24.ru

# Добавление отдела
POST /api/access-control/departments
{
    "department_id": 1,
    "department_name": "Отдел продаж"
}

# Добавление пользователя
POST /api/access-control/users
{
    "user_id": 123,
    "user_name": "Иван Иванов",
    "user_email": "ivan@example.com"
}

# Удаление отдела
DELETE /api/access-control/departments/1

# Удаление пользователя
DELETE /api/access-control/users/123
```

### 2. Frontend компоненты

#### 2.1. AccessControlPage.vue

**Путь:** `APP-B24/frontend/src/components/AccessControlPage.vue`

**Назначение:** Vue.js компонент для управления правами доступа.

**Функциональность:**

1. **Отображение конфигурации**
   - Список отделов с доступом
   - Список пользователей с доступом
   - Переключатель включения/выключения проверки

2. **Управление отделами**
   - Добавление отдела (ID + название)
   - Удаление отдела

3. **Управление пользователями**
   - Добавление пользователя (ID + имя + email)
   - Удаление пользователя

4. **Навигация**
   - Кнопка "Назад" для возврата на главную страницу

**Используемые зависимости:**

- `vue-router` — для навигации
- `pinia` — для управления состоянием
- `@/stores/accessControlStore` — store для работы с API
- `@/utils/bitrix24` — утилиты для уведомлений

#### 2.2. accessControlStore.js

**Путь:** `APP-B24/frontend/src/stores/accessControlStore.js`

**Назначение:** Pinia store для управления состоянием модуля администрирования.

**State:**

```javascript
{
    config: null,           // Конфигурация прав доступа
    departments: [],       // Список отделов
    users: [],             // Список пользователей
    loading: false,        // Флаг загрузки
    error: null            // Ошибка (если есть)
}
```

**Getters:**

```javascript
isEnabled()              // Проверка включения системы
enabledDepartments()     // Список отделов с доступом
enabledUsers()          // Список пользователей с доступом
```

**Actions:**

```javascript
fetchConfig()           // Загрузка конфигурации
addDepartment()         // Добавление отдела
removeDepartment()      // Удаление отдела
addUser()              // Добавление пользователя
removeUser()           // Удаление пользователя
```

**API клиент:**

Используется `@/services/api` для HTTP-запросов к backend API.

---

## Поток работы модуля

### 1. Проверка доступа пользователя

```
┌─────────────┐
│   Пользователь    │
│   запрашивает     │
│   доступ          │
└─────────────┘
        │
        ▼
┌─────────────────────────────┐
│  AccessControlService::      │
│  checkUserAccess()           │
└─────────────────────────────┘
        │
        ├─► Проверка статуса администратора
        │   (UserService::isAdmin())
        │
        ├─► Проверка включения системы
        │   (access_control.enabled)
        │
        ├─► Проверка отделов
        │   (departments)
        │
        └─► Проверка пользователей
            (users)
        │
        ▼
┌─────────────────────────────┐
│  Результат:                  │
│  - Доступ разрешён          │
│  - Доступ запрещён          │
└─────────────────────────────┘
```

### 2. Управление правами доступа (администратор)

```
┌─────────────┐
│ Администратор │
│ открывает     │
│ страницу      │
│ администрир.  │
└─────────────┘
        │
        ▼
┌─────────────────────────────┐
│  AccessControlPage.vue       │
│  (Vue.js компонент)         │
└─────────────────────────────┘
        │
        ├─► onMounted()
        │   └─► store.fetchConfig()
        │       └─► GET /api/access-control
        │
        ▼
┌─────────────────────────────┐
│  API Endpoint                 │
│  (access-control.php)         │
└─────────────────────────────┘
        │
        ├─► Проверка авторизации
        ├─► Проверка прав администратора
        └─► ConfigService::getAccessConfig()
        │
        ▼
┌─────────────────────────────┐
│  access-config.json          │
│  (JSON конфигурация)          │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  Отображение конфигурации    │
│  в UI                        │
└─────────────────────────────┘
```

### 3. Добавление отдела/пользователя

```
┌─────────────┐
│ Администратор │
│ добавляет     │
│ отдел/        │
│ пользователя  │
└─────────────┘
        │
        ▼
┌─────────────────────────────┐
│  AccessControlPage.vue       │
│  addDepartment() /          │
│  addUser()                   │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  accessControlStore          │
│  addDepartment() /          │
│  addUser()                   │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  POST /api/access-control/   │
│  departments или users       │
└─────────────────────────────┘
        │
        ├─► Проверка авторизации
        ├─► Проверка прав администратора
        └─► AccessControlService::addDepartment() / addUser()
        │
        ▼
┌─────────────────────────────┐
│  ConfigService::             │
│  saveAccessConfig()          │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  access-config.json          │
│  (обновление файла)          │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  store.fetchConfig()         │
│  (обновление UI)             │
└─────────────────────────────┘
```

---

## Безопасность

### 1. Проверка авторизации

- Все API endpoints требуют наличия `AUTH_ID` (или `APP_SID`) и `DOMAIN`
- Используется middleware `auth.php` для проверки авторизации

### 2. Проверка прав администратора

- Только администраторы могут управлять правами доступа
- Проверка выполняется через `UserService::isAdmin()`
- Используется метод Bitrix24 API `user.admin` для дополнительной проверки

### 3. Валидация данных

- Проверка наличия обязательных полей (ID, имя)
- Проверка типов данных (int для ID, string для имени)
- Проверка на дубликаты (отдел/пользователь уже в списке)

### 4. Логирование

- Все операции управления правами логируются
- Проверки доступа фиксируются в логах
- Ошибки сохраняются с детальной информацией

---

## Логирование

### Типы логов

1. **Логи проверки доступа**
   - Метод: `LoggerService::logAccessCheck()`
   - Параметры: `userId`, `userDepartments`, `result`, `reason`

2. **Логи управления правами**
   - Метод: `LoggerService::logAccessControl()`
   - Параметры: `action`, `data`

3. **Логи ошибок конфигурации**
   - Метод: `LoggerService::logAccessConfigSaveError()`
   - Параметры: `error`, `context`

### Примеры логов

```
[2025-12-21 16:00:00] ACCESS CHECK: user_id=123, departments=[1,2], result=granted, reason=admin
[2025-12-21 16:00:01] ACCESS CONTROL: action=add_department, department_id=1, department_name=Отдел продаж
[2025-12-21 16:00:02] ACCESS CONFIG SAVE ERROR: Файл конфигурации недоступен для записи
```

---

## Интеграция с Bitrix24

### Используемые методы Bitrix24 REST API

1. **user.admin**
   - Назначение: Проверка статуса администратора
   - Документация: https://context7.com/bitrix24/rest/user.admin
   - Используется в: `Bitrix24ApiService::checkIsAdmin()`

2. **user.get**
   - Назначение: Получение данных пользователя
   - Документация: https://context7.com/bitrix24/rest/user.get
   - Используется в: `UserService::getCurrentUser()`

### Поля пользователя Bitrix24

- `ADMIN` — статус администратора ('Y' или 'N')
- `IS_ADMIN` — альтернативное поле статуса администратора
- `UF_DEPARTMENT` — массив ID отделов пользователя
- `ID` — ID пользователя
- `NAME` — имя пользователя
- `LAST_NAME` — фамилия пользователя

---

## Файловая структура

```
APP-B24/
├── src/
│   └── Services/
│       ├── AccessControlService.php    # Сервис управления правами
│       ├── ConfigService.php           # Работа с конфигурацией
│       └── UserService.php             # Работа с пользователями
├── api/
│   └── routes/
│       └── access-control.php          # API endpoint
├── frontend/
│   └── src/
│       ├── components/
│       │   └── AccessControlPage.vue   # Vue.js компонент
│       └── stores/
│           └── accessControlStore.js   # Pinia store
├── access-config.json                  # Конфигурация прав доступа
└── logs/
    └── info-*.log                      # Логи операций
```

---

## Примеры использования

### 1. Проверка доступа пользователя

```php
<?php

use App\Services\AccessControlService;
use App\Services\UserService;

// Инициализация сервисов
$accessControlService = new AccessControlService(
    $configService,
    $apiService,
    $userService,
    $logger
);

// Проверка доступа
$hasAccess = $accessControlService->checkUserAccess(
    $userId = 123,
    $userDepartments = [1, 2],
    $authId = 'xxx',
    $domain = 'example.bitrix24.ru'
);

if ($hasAccess) {
    echo "Доступ разрешён";
} else {
    echo "Доступ запрещён";
}
```

### 2. Добавление отдела через API

```bash
curl -X POST "https://example.com/api/access-control/departments" \
  -H "Content-Type: application/json" \
  -d '{
    "AUTH_ID": "xxx",
    "DOMAIN": "example.bitrix24.ru",
    "department_id": 1,
    "department_name": "Отдел продаж"
  }'
```

### 3. Получение конфигурации через API

```bash
curl -X GET "https://example.com/api/access-control?AUTH_ID=xxx&DOMAIN=example.bitrix24.ru"
```

---

## Ограничения и особенности

### 1. Хранение конфигурации

- Конфигурация хранится в JSON-файле (`access-config.json`)
- Нет поддержки одновременных записей (риск потери данных)
- Рекомендуется использовать БД для production

### 2. Проверка прав администратора

- Проверка выполняется при каждом запросе к API
- Используется кеширование в Bitrix24 API (если доступно)

### 3. Производительность

- При большом количестве отделов/пользователей проверка может быть медленной
- Рекомендуется использовать индексы в БД (если перейти на БД)

---

## Рекомендации по улучшению

1. **Миграция на БД**
   - Использовать MySQL/PostgreSQL вместо JSON-файла
   - Добавить индексы для быстрого поиска

2. **Кеширование**
   - Кешировать конфигурацию прав доступа в Redis
   - Инвалидировать кеш при изменении конфигурации

3. **Асинхронная обработка**
   - Использовать очереди для обновления конфигурации
   - Добавить фоновую синхронизацию с Bitrix24

4. **Мониторинг**
   - Добавить метрики проверок доступа
   - Отслеживать частоту отказов в доступе

---

## История изменений

- **2025-12-21 16:00 (UTC+3, Брест):** Создан анализ модуля "Администрирование"

---

## Проблемы при реализации и их решения

### Проблема с роутингом API (2025-12-21 19:40, UTC+3, Брест)

**Описание проблемы:**

При переходе в режим "Администрирование" возникала ошибка 404 при попытке загрузить конфигурацию через API endpoint `/api/access-control`. Аналогичная проблема возникала при запросах к `/api/users` и `/api/departments`.

**Причины проблемы:**

1. **Конфликт старых и новых файлов API:**
   - В директории `/api/` существовал старый файл `access-control.php`, который перехватывал запросы до того, как они попадали в `index.php`
   - Сервер обрабатывал запросы к `/api/access-control` напрямую через старый файл, а не через новую систему роутинга через `index.php`

2. **Неправильная обработка маршрутов в перехватчике axios:**
   - Перехватчик в `frontend/src/services/api.js` не преобразовывал URL для маршрутов через `index.php`
   - Запросы шли напрямую на `/api/access-control` вместо `/api/index.php?route=access-control`

3. **Отсутствие маршрута для `users` в `index.php`:**
   - В `index.php` не был добавлен case для маршрута `users`, хотя файл `users.php` существовал

4. **Проблемы с передачей параметров в `index.php`:**
   - Когда `route` передавался через query-параметр как строка `access-control/departments/bulk`, он не разбивался на сегменты правильно
   - Переменная `$segments` не сохранялась в глобальную область видимости для использования в routes

**Решения:**

1. **Удаление старого файла `access-control.php`:**
   ```bash
   # Удален файл /api/access-control.php
   # Теперь все запросы обрабатываются через index.php
   ```

2. **Исправление перехватчика axios:**
   - Добавлена логика преобразования URL для маршрутов через `index.php`
   - Все запросы к маршрутам из списка `indexRoutes` теперь преобразуются в `/index.php?route=...`
   - Исправлено объединение параметров (route, AUTH_ID, DOMAIN) с использованием spread-оператора

3. **Добавление маршрута для `users` в `index.php`:**
   ```php
   case 'users':
       require_once(__DIR__ . '/users.php');
       break;
   ```

4. **Исправление обработки query-параметров в `index.php`:**
   - Добавлена логика разбиения `route` из query-параметра на сегменты
   - Переменная `$segments` всегда сохраняется в `$GLOBALS['segments']` для использования в routes
   - Улучшена обработка пути для корректного удаления префиксов

5. **Исправление порядка проверок в `routes/access-control.php`:**
   - Изменен порядок проверок для bulk-эндпоинтов — сначала проверяется `bulk`, затем обычное добавление
   - Это необходимо, чтобы bulk-эндпоинты (`/departments/bulk`, `/users/bulk`) обрабатывались корректно

**Результат:**

После внесения всех исправлений:
- ✅ Запросы к `/api/access-control` обрабатываются через `index.php` и попадают в `routes/access-control.php`
- ✅ Запросы к `/api/users` обрабатываются через `index.php` и попадают в `users.php`
- ✅ Запросы к `/api/departments` обрабатываются через `index.php` и попадают в `routes/departments.php`
- ✅ Bulk-эндпоинты (`/departments/bulk`, `/users/bulk`) работают корректно
- ✅ Все запросы логируются для отладки

**Уроки:**

1. При миграции на новую систему роутинга необходимо удалять старые файлы, которые могут перехватывать запросы
2. Важно обеспечить единообразную обработку всех маршрутов через единую точку входа (`index.php`)
3. При работе с query-параметрами нужно правильно разбивать сложные значения на сегменты
4. Порядок проверок в условных конструкциях критичен для корректной обработки многоуровневых путей

---

## Связанные документы

- `DOCS/ARCHITECTURE/application-architecture.md` — архитектура приложения
- `DOCS/GUIDES/settings-usage.md` — руководство по настройкам
- `DOCS/API-REFERENCES/bitrix24-rest-api.md` — документация Bitrix24 REST API

---

**Автор:** Технический писатель  
**Дата последнего обновления:** 2025-12-21 19:40 (UTC+3, Брест)

